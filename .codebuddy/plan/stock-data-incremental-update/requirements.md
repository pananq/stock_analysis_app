# 需求文档：股票历史行情数据增量更新优化

## 引言

当前系统在更新股票历史行情数据时，每次都会全量下载数据，即使大部分数据已经存在于数据库中。这种方式导致：
1. 数据源调用次数过多，可能触发API限流
2. 数据更新效率低，浪费网络和计算资源
3. 更新时间长，影响系统可用性

本功能旨在通过记录每只股票已下载历史数据的时间范围，实现增量数据更新，仅下载缺失的时间段数据，从而提高数据更新效率，减少不必要的API调用。

## 需求

### 需求 1：股票数据时间范围记录

**用户故事：** 作为一名系统管理员，我希望系统能够记录每只股票在数据库中保存的历史行情数据的最早日期和最近日期，以便系统能够识别需要更新的数据范围。

#### 验收标准

1. WHEN 系统创建 `stocks` 表时，THEN 系统 SHALL 在表中添加 `earliest_data_date` 字段（类型为 DATE）和 `latest_data_date` 字段（类型为 DATE）
2. WHEN 系统首次下载某只股票的历史行情数据并保存到数据库时，THEN 系统 SHALL 将该股票的 `earliest_data_date` 设置为下载的数据中的最早交易日期
3. WHEN 系统首次下载某只股票的历史行情数据并保存到数据库时，THEN 系统 SHALL 将该股票的 `latest_data_date` 设置为下载的数据中的最近交易日期
4. IF 股票尚无历史数据，THEN 系统 SHALL 将 `earliest_data_date` 和 `latest_data_date` 设置为 NULL
5. WHEN 系统读取股票数据时间范围时，THEN 系统 SHALL 确保日期格式为 YYYY-MM-DD
6. WHEN 系统更新股票数据时间范围时，THEN 系统 SHALL 使用事务确保两个字段的原子性更新

### 需求 2：增量数据更新策略

**用户故事：** 作为一名系统管理员，我希望在更新股票行情数据时，系统只下载从最近日期到当日之间的缺失数据，以便减少数据源调用次数并提高更新效率。

#### 验收标准

1. WHEN 系统执行数据更新任务时，THEN 系统 SHALL 检查每只股票的 `latest_data_date` 字段
2. IF 股票的 `latest_data_date` 为 NULL（首次下载数据），THEN 系统 SHALL 下载该股票的完整历史数据（从上市日期或指定起始日期到当前日期）
3. IF 股票的 `latest_data_date` 不为 NULL，THEN 系统 SHALL 只下载从 `latest_data_date` 之后的交易日到当前日期之间的数据
4. WHEN 系统下载数据时，THEN 系统 SHALL 将数据下载的起始日期设置为 `latest_data_date + 1天`
5. WHEN 系统下载新数据并保存后，THEN 系统 SHALL 更新该股票的 `latest_data_date` 为最新数据的交易日期
6. IF 股票的 `earliest_data_date` 为 NULL 且首次下载数据，THEN 系统 SHALL 设置 `earliest_data_date` 为最早数据的交易日期
7. WHEN 系统执行增量更新时，THEN 系统 SHALL 跳过已存在的数据记录，避免重复插入

### 需求 3：交易日间隔智能判断

**用户故事：** 作为一名系统管理员，我希望系统能够判断股票数据的最近日期与当前日期之间是否存在交易日，如果不存在则跳过该股票的数据更新，以便节省不必要的API调用。

#### 验收标准

1. WHEN 系统准备更新某只股票数据时，THEN 系统 SHALL 检查 `latest_data_date` 与当前日期之间的时间间隔
2. IF `latest_data_date` 等于当前日期，THEN 系统 SHALL 跳过该股票的数据更新，不调用数据源API
3. IF `latest_data_date` 与当前日期之间是周末或非交易日，THEN 系统 SHALL 跳过该股票的数据更新
4. WHEN 系统判断交易日时，THEN 系统 SHALL 使用A股市场的交易日历规则（排除周末和法定节假日）
5. IF 系统无法确定交易日历，THEN 系统 SHALL 默认跳过周末（周六、周日）
6. WHEN 系统跳过股票更新时，THEN 系统 SHALL 在日志中记录跳过原因（如"数据已是最新"或"期间无交易日"）

### 需求 4：数据完整性保障

**用户故事：** 作为一名系统管理员，我希望在增量更新过程中系统能够确保数据的完整性，防止因增量更新导致数据缺失或不连续。

#### 验收标准

1. WHEN 系统执行增量更新时，THEN 系统 SHALL 验证下载数据的日期连续性
2. IF 发现数据存在日期间隔（日期不连续），THEN 系统 SHALL 在日志中记录警告信息
3. WHEN 系统保存数据时，THEN 系统 SHALL 检查数据记录是否已存在（通过 code + trade_date 唯一索引）
4. IF 数据记录已存在，THEN 系统 SHALL 跳过插入或执行更新操作（根据配置决定）
5. WHEN 系统更新 `latest_data_date` 时，THEN 系统 SHALL 确保该日期是数据库中该股票的实际最大交易日期
6. IF 增量更新失败或中断，THEN 系统 SHALL 保持原有的 `latest_data_date` 不变，确保下次重试时能正确恢复

### 需求 5：数据更新历史跟踪

**用户故事：** 作为一名数据运维人员，我希望能够查看每只股票的数据更新历史和时间范围变化，以便监控数据质量和更新策略执行情况。

#### 验收标准

1. WHEN 系统更新股票数据时，THEN 系统 SHALL 在 `data_update_history` 表中记录更新信息
2. WHEN 系统记录数据更新历史时，THEN 系统 SHALL 包含更新类型（全量/增量）、更新的股票代码、更新前的日期范围、更新后的日期范围
3. WHEN 系统记录数据更新历史时，THEN 系统 SHALL 记录本次下载的数据条数、成功条数和失败条数
4. WHEN 系统执行增量更新时，THEN 系统 SHALL 在 `data_update_history` 表的 `update_type` 字段中标注为"增量"
5. WHEN 系统执行全量更新时，THEN 系统 SHALL 在 `data_update_history` 表的 `update_type` 字段中标注为"全量"
6. WHEN 系统完成数据更新后，THEN 系统 SHALL 在日志中输出更新摘要，包括更新的股票数量、数据条数、日期范围变更等信息

### 需求 6：手动全量更新支持

**用户故事：** 作为一名系统管理员，我希望能够对特定股票或所有股票手动触发全量数据更新，以便在数据出现问题时能够重新下载完整数据。

#### 验收标准

1. WHEN 用户通过API或配置指定执行全量更新时，THEN 系统 SHALL 忽略 `latest_data_date` 字段，重新下载完整的历史数据
2. WHEN 系统执行全量更新时，THEN 系统 SHALL 保留原有的 `earliest_data_date` 不变，仅更新 `latest_data_date`
3. WHEN 系统执行全量更新时，THEN 系统 SHALL 在 `data_update_history` 表中将 `update_type` 标注为"全量-手动"
4. IF 全量更新发现数据时间范围发生变化（如更早的历史数据），THEN 系统 SHALL 更新 `earliest_data_date`
5. WHEN 用户指定全量更新某只股票时，THEN 系统 SHALL 在日志中明确记录"执行全量更新：股票代码"

### 需求 7：数据范围查询接口

**用户故事：** 作为一名系统用户，我希望能够查询每只股票的数据覆盖范围（最早日期和最近日期），以便了解数据的完整性和时效性。

#### 验收标准

1. WHEN 用户通过API查询股票列表时，THEN 系统 SHALL 返回每只股票的 `earliest_data_date` 和 `latest_data_date` 字段
2. WHEN 用户查询股票详情时，THEN 系统 SHALL 显示该股票的数据时间范围和天数统计
3. IF 股票的 `earliest_data_date` 或 `latest_data_date` 为 NULL，THEN 系统 SHALL 返回明确的标识（如"无数据"或空字符串）
4. WHEN 系统计算数据天数时，THEN 系统 SHALL 基于实际的交易日数量（排除非交易日）
5. WHEN API返回数据时间范围时，THEN 系统 SHALL 使用 ISO 8601 标准的日期格式（YYYY-MM-DD）

### 需求 8：向后兼容性

**用户故事：** 作为一名系统管理员，我希望新增的增量更新功能能够兼容现有的数据库和代码，以便平滑升级而不影响现有功能。

#### 验收标准

1. WHEN 系统升级时，THEN 系统 SHALL 为现有数据库自动添加 `earliest_data_date` 和 `latest_data_date` 字段
2. WHEN 系统首次升级后，THEN 系统 SHALL 将 `earliest_data_date` 和 `latest_data_date` 初始化为 NULL
3. IF 现有数据需要回填时间范围，THEN 系统 SHALL 提供一个管理命令或脚本来计算并设置每只股票的日期范围
4. WHEN 系统检测到字段不存在时，THEN 系统 SHALL 自动执行数据库迁移脚本
5. WHEN 数据库迁移执行时，THEN 系统 SHALL 备份现有数据并记录迁移日志
6. IF 迁移失败，THEN 系统 SHALL 支持回滚到迁移前的状态

## 非功能性需求

### 性能需求
- 增量更新相比全量更新，数据源API调用次数应减少至少 80%（对于已覆盖大部分历史数据的股票）
- 单次数据更新任务的完成时间应减少至少 60%
- 数据时间范围查询响应时间应小于 100ms

### 可靠性需求
- 增量更新过程中的任何失败不应影响已存在的数据
- 系统应能够从更新失败中自动恢复，并在下次任务中继续执行
- 数据时间范围字段的更新应与数据保存在同一事务中

### 可维护性需求
- 应提供日志记录每次增量更新的详细信息，包括跳过的股票、下载的数据量等
- 应提供监控指标，如增量更新命中率、平均下载天数等
- 应提供管理接口用于查看和手动调整股票的数据时间范围

## 边界情况和限制

1. **停牌股票**：长期停牌的股票，`latest_data_date` 可能远早于当前日期，系统应正确识别并跳过更新
2. **退市股票**：退市股票的 `latest_data_date` 应为最后交易日期，系统不应尝试更新到当前日期
3. **新上市股票**：新上市股票的 `earliest_data_date` 应为上市首日
4. **数据源限制**：某些数据源可能不支持增量查询，系统应优雅降级为全量更新
5. **节假日处理**：系统应正确处理春节等长假期间的交易日判断
6. **历史数据补全**：如果 `earliest_data_date` 后发现了更早的数据，应支持手动触发补全

## 成功标准

- [ ] 系统能够正确记录每只股票的数据时间范围
- [ ] 增量更新功能能够正确识别并只下载缺失数据
- [ ] 系统能够智能判断并跳过无交易日期间的更新
- [ ] 增量更新后的数据完整性和准确性得到保障
- [ ] 用户能够查询股票的数据覆盖范围
- [ ] 功能向后兼容，现有系统能够平滑升级
- [ ] 数据源API调用次数显著减少，更新效率提升
- [ ] 日志和监控功能完善，便于问题排查和性能优化
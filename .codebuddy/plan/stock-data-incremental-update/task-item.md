# 实施计划：股票历史行情数据增量更新优化

- [ ] 1. 修改数据库表结构和模型
   - 在 `stocks` 表添加 `earliest_data_date` 和 `latest_data_date` 字段（DATE类型）
   - 更新 `Stock` 数据模型类，添加日期范围属性
   - 为日期范围字段添加索引以优化查询性能
   - _需求：1.1、1.5、8.1_

- [ ] 2. 实现交易日判断工具
   - 创建交易日历工具类 `TradingDayHelper`
   - 实现判断两个日期之间是否存在交易日的逻辑
   - 实现排除周末（周六、周日）的功能
   - 添加对A股法定节假日的支持（可选配置）
   - _需求：3.4、3.5_

- [ ] 3. 实现股票数据时间范围管理服务
   - 创建 `StockDateRangeService` 服务类
   - 实现获取股票数据时间范围的方法
   - 实现更新股票数据时间范围的方法（包含事务处理）
   - 实现检查是否需要更新的判断逻辑
   - _需求：1.2、1.3、1.6、3.1、3.2、3.3_

- [ ] 4. 重构数据更新核心逻辑
   - 修改 `MarketDataService` 类的更新方法，支持增量更新和全量更新模式
   - 实现根据 `latest_data_date` 计算下载起始日期的逻辑
   - 实现数据保存时自动更新时间范围字段的功能
   - 添加数据跳过和重复记录检查机制
   - _需求：2.1、2.2、2.3、2.4、2.5、2.6、2.7、4.2、4.3、4.4_

- [ ] 5. 增强数据完整性和错误处理
   - 实现下载数据日期连续性验证
   - 添加数据间隔警告日志记录功能
   - 实现增量更新失败时的回滚机制（保持 `latest_data_date` 不变）
   - 添加事务保证数据和时间范围同步更新
   - _需求：4.1、4.5、4.6_

- [ ] 6. 实现数据更新历史跟踪
   - 修改 `data_update_history` 表结构，添加日期范围相关字段（如果需要）
   - 在数据更新方法中记录更新类型（增量/全量）、更新前后的日期范围、数据条数
   - 实现更新摘要日志输出功能
   - _需求：5.1、5.2、5.3、5.4、5.5、5.6_

- [ ] 7. 实现手动全量更新支持
   - 在更新任务中添加全量更新模式参数或配置选项
   - 实现强制全量更新时的逻辑（忽略 `latest_data_date`，保留 `earliest_data_date`）
   - 添加手动触发全量更新的API接口或命令行参数
   - 在日志中明确标识全量更新操作
   - _需求：6.1、6.2、6.3、6.5_

- [ ] 8. 更新API接口
   - 修改股票列表查询接口，返回 `earliest_data_date` 和 `latest_data_date` 字段
   - 修改股票详情接口，显示数据时间范围和天数统计
   - 处理日期为NULL的情况，返回明确的标识
   - 确保日期格式符合ISO 8601标准（YYYY-MM-DD）
   - _需求：7.1、7.2、7.3、7.5_

- [ ] 9. 创建数据库迁移和数据回填工具
   - 编写数据库迁移脚本，自动添加新字段并初始化为NULL
   - 创建管理命令或脚本，用于为现有数据回填时间范围
   - 实现迁移日志记录和备份机制
   - 添加迁移失败时的回滚支持
   - _需求：8.1、8.2、8.3、8.4、8.5、8.6_

- [ ] 10. 编写单元测试和集成测试
   - 为 `StockDateRangeService` 编写测试用例
   - 为 `TradingDayHelper` 编写测试用例
   - 为增量更新逻辑编写集成测试
   - 测试边界情况（停牌股票、退市股票、新上市股票）
   - 测试向后兼容性和数据库迁移
   - _需求：所有需求的验证_


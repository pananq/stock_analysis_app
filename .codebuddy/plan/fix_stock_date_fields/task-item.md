# 实施计划

- [ ] 1. 创建日期范围管理的数据库查询方法
   - 在 Stock 模型或相关的 repository 层中添加方法，用于查询股票在 daily_market 表中的最小和最大交易日期
   - 添加批量查询方法，支持一次查询多只股票的日期范围
   - 添加批量更新 stocks 表 earliest_data_date 和 latest_data_date 字段的方法
   - _需求：1、2.2、3.2、6.1_

- [ ] 2. 实现初始化修复已有数据的日期字段
   - 创建独立的管理命令或服务方法，扫描 stocks 表中日期字段为 NULL 的股票
   - 对每只 NULL 股票，从 daily_market 表查询其历史数据日期范围
   - 将查询到的日期范围批量更新到 stocks 表
   - 记录修复的股票数量和详细信息到日志
   - _需求：1.1、1.2、1.3、1.4_

- [ ] 3. 在增量更新方法中集成日期字段维护逻辑
   - 修改 market_data_service.py 中的增量更新方法
   - 在 daily_market 表数据插入成功后，计算当前批次的最小和最大日期
   - 更新 stocks 表对应股票的 earliest_data_date 和 latest_data_date
   - 确保所有更新操作在同一数据库事务中执行
   - _需求：2.1、2.2、2.3、5.1、5.2、5.3_

- [ ] 4. 在全量更新方法中集成日期字段重新计算逻辑
   - 修改 market_data_service.py 中的全量更新方法
   - 在 daily_market 表数据更新完成后，从表中重新查询该股票的完整日期范围
   - 更新 stocks 表的 earliest_data_date 和 latest_data_date 字段
   - 确保全量更新失败时保持原有日期字段不变
   - _需求：3.1、3.2、3.3、3.4、5.1、5.2_

- [ ] 5. 在新增股票首次下载时设置日期字段
   - 修改市场数据服务中首次下载股票数据的逻辑
   - 在首次插入 daily_market 数据后，立即计算日期范围
   - 将计算结果设置到 stocks 表对应记录中
   - 确保首次下载失败时保持 stocks 表日期字段为 NULL
   - _需求：4.1、4.2、4.3、5.1、5.2_

- [ ] 6. 实现批量更新性能优化
   - 创建批量更新 stocks 表日期字段的高效 SQL 方法
   - 支持使用单条 SQL 语句更新多只股票的日期字段
   - 实现分批次更新逻辑，当批量更新超过 100 只股票时分批处理
   - 在所有日期更新场景中应用批量更新方法
   - _需求：6.1、6.2、6.3_

- [ ] 7. 编写单元测试验证日期字段维护逻辑
   - 为初始化修复功能编写单元测试
   - 为增量更新日期维护逻辑编写单元测试
   - 为全量更新日期重新计算编写单元测试
   - 为批量更新性能优化方法编写单元测试
   - 测试事务完整性和错误回滚场景
   - _需求：1、2.4、3.4、4.3、5.2、5.3_

- [ ] 8. 集成测试验证完整流程
   - 测试从初始化修复到增量更新的完整流程
   - 测试全量更新后的日期字段准确性
   - 测试新增股票的日期字段设置
   - 测试批量更新性能和正确性
   - 验证事务完整性在各种错误场景下的表现
   - _需求：1、2、3、4、5、6_

# SQLite 到 MySQL 8.0 数据库迁移 - 任务清单

## 实施计划

- [ ] 1. 实现数据库配置管理模块
   - 在配置文件中添加 MySQL 连接参数配置项（host、port、database、username、password）
   - 实现配置验证逻辑，检查必需的配置项是否存在
   - 实现环境变量覆盖配置功能，优先使用环境变量中的数据库配置
   - 添加配置热重载支持，修改配置文件后无需重启应用
   - _需求：2.1、2.2、2.3、2.6_

- [ ] 2. 开发 MySQL 数据库适配器基础类
   - 创建 `MySQLDB` 类，提供与 `SQLiteDB` 相同的 API 接口
   - 实现 PyMySQL 连接池管理，支持至少 50 个并发连接
   - 实现参数化查询方法，防止 SQL 注入攻击
   - 实现事务处理方法，支持批量操作时的事务管理
   - 实现数据库连接超时和自动关闭机制
   - _需求：1.1、1.2、1.3、1.4、1.5、1.7、7.2、7.5_

- [ ] 3. 实现 MySQL 表结构自动创建功能
   - 定义 7 个数据表的 MySQL 表结构（stocks、strategies、strategy_results、system_logs、data_update_history、job_logs、task_execution_details）
   - 实现数据类型映射逻辑（TEXT→VARCHAR/VARCHAR(n)、INTEGER→INT、REAL→DECIMAL(10,4)）
   - 为所有表创建必要的索引（主键、外键、常用查询条件）
   - 实现 `IF NOT EXISTS` 逻辑，跳过已存在的表
   - 添加表创建失败时的回滚机制
   - _需求：3.1、3.2、3.3、3.4、3.7、7.1_

- [ ] 4. 实现数据库适配器工厂和统一接口
   - 创建数据库适配器工厂类，根据配置动态选择 SQLiteDB 或 MySQLDB
   - 实现统一的数据访问接口抽象层
   - 确保业务逻辑代码无需修改即可切换数据库类型
   - 添加数据库类型配置验证逻辑
   - _需求：10.1、10.2、10.3、10.4、10.5_

- [ ] 5. 开发数据迁移工具核心功能
   - 在 `tools` 目录下创建数据迁移工具脚本
   - 实现 SQLite 数据读取功能，支持读取所有表的数据
   - 实现表依赖关系分析，确定正确的迁移顺序（先主表后从表）
   - 实现批量插入功能，每批插入 1000 条记录以提高性能
   - 实现时间格式转换，将 SQLite 时间字符串转换为 MySQL DATETIME 格式
   - _需求：4.1、4.2、4.8、7.3_

- [ ] 6. 实现迁移工具的进度显示和错误处理
   - 实现进度条显示，实时展示迁移进度（当前表、已迁移记录数）
   - 实现迁移错误日志记录功能
   - 实现迁移失败时的继续或回滚选项
   - 添加迁移统计信息显示（成功/失败的记录数、耗时）
   - 实现迁移前检查，如果 MySQL 表中有数据则提示用户选择覆盖或跳过
   - _需求：4.5、4.6、4.7、4.9、8.6_

- [ ] 7. 开发数据验证和一致性检查功能
   - 实现记录数量对比功能，对比 SQLite 和 MySQL 中每个表的记录数
   - 实现抽样验证功能，抽样对比关键字段的内容
   - 实现差异详情记录功能，记录数据内容不一致的详细信息
   - 实现验证报告生成功能，将验证结果保存到指定目录
   - 添加验证失败时的修复建议或自动回滚选项
   - _需求：5.1、5.2、5.3、5.4、5.5、5.6_

- [ ] 8. 实现迁移回滚机制
   - 实现迁移前 SQLite 数据库文件备份功能
   - 实现配置恢复功能，将数据库配置恢复为 SQLite
   - 实现 MySQL 数据清理功能（可选），删除已迁移的数据
   - 添加回滚确认功能，确保系统可以正常运行
   - 实现手动恢复步骤文档生成功能
   - _需求：6.1、6.2、6.3、6.4、6.5、6.6_

- [ ] 9. 实现日志和监控功能
   - 在 MySQLDB 类中添加详细的操作日志记录（查询语句、执行时间、影响行数）
   - 实现错误堆栈信息记录功能
   - 实现慢查询日志记录功能，记录响应时间超过阈值的查询
   - 实现数据库连接数监控和警告日志记录功能
   - _需求：8.1、8.2、8.4、8.5_

- [ ] 10. 编写迁移文档和使用指南
   - 生成 MySQL 版本的数据库 Schema 文档（`docs/database/mysql_schema.md`）
   - 创建 MySQL 建表 SQL 脚本（`docs/database/mysql_create_tables.sql`）
   - 编写数据迁移工具使用说明文档（`docs/mysql-migration-guide.md`）
   - 编写回滚操作指南文档（`docs/mysql-rollback-guide.md`）
   - 更新配置文档，添加 MySQL 相关配置说明
   - _需求：9.1、9.2、9.3、9.4、9.5_

# SQLite 到 MySQL 8.0 数据库迁移需求文档

## 引言

当前项目使用 SQLite 数据库存储股票分析相关数据，包括股票基础信息、策略配置、执行结果、系统日志等。随着数据量的增长和系统的扩展，SQLite 在并发处理、性能、可维护性方面存在限制。为了提升系统的可扩展性和性能，需要将数据库迁移到 MySQL 8.0。

本需求文档定义了从 SQLite 迁移到 MySQL 8.0 的完整方案，包括数据库适配器开发、数据迁移工具开发、配置管理、数据验证、回滚机制等。

## 需求

### 需求 1：MySQL 数据库适配器开发

**用户故事：** 作为一名【开发者】，我希望【提供一个统一的 MySQL 数据库访问接口】，以便【替换现有的 SQLite 数据库实现，保持代码一致性】。

#### 验收标准

1. WHEN 系统启动时 THEN 系统 SHALL 使用配置文件中的 MySQL 连接参数建立数据库连接
2. WHEN 数据库连接失败 THEN 系统 SHALL 记录错误日志并抛出异常
3. WHEN 执行查询操作时 THEN 系统 SHALL 支持参数化查询以防止 SQL 注入
4. WHEN 执行批量操作时 THEN 系统 SHALL 支持事务处理以确保数据一致性
5. WHEN 数据库连接空闲超过配置时间 THEN 系统 SHALL 自动关闭连接
6. IF 数据库连接参数配置错误 THEN 系统 SHALL 在启动时提示配置错误
7. WHEN 使用数据库适配器时 THEN 系统 SHALL 提供与 SQLiteDB 相同的 API 接口（execute_query、execute_update、insert_one、update_one 等）

---

### 需求 2：数据库配置管理

**用户故事：** 作为一名【系统管理员】，我希望【通过配置文件管理 MySQL 数据库连接参数】，以便【灵活切换数据库环境而无需修改代码】。

#### 验收标准

1. WHEN 系统启动时 THEN 系统 SHALL 从配置文件读取 MySQL 连接参数（host、port、database、username、password）
2. WHEN 配置文件中缺少必要的 MySQL 配置 THEN 系统 SHALL 提示缺失的配置项
3. WHEN 使用环境变量覆盖配置时 THEN 系统 SHALL 优先使用环境变量中的配置
4. WHEN 数据库密码包含特殊字符时 THEN 系统 SHALL 正确处理密码转义
5. WHEN 修改配置文件后 THEN 系统 SHALL 支持热重载配置而无需重启应用
6. WHEN 配置验证失败时 THEN 系统 SHALL 提供清晰的错误提示信息

---

### 需求 3：MySQL 表结构创建

**用户故事：** 作为一名【开发者】，我希望【根据 SQLite 表结构自动创建 MySQL 对应的表】，以便【快速完成数据库初始化】。

#### 验收标准

1. WHEN 系统首次启动时 THEN 系统 SHALL 自动创建所有必要的数据库表
2. WHEN 表已存在时 THEN 系统 SHALL 跳过创建而不报错
3. WHEN 创建表时 THEN 系统 SHALL 将 SQLite 的数据类型正确映射到 MySQL 类型（TEXT→VARCHAR/VARCHAR(n)、INTEGER→INT、REAL→DECIMAL）
4. WHEN 创建表时 THEN 系统 SHALL 自动创建所有必要的索引
5. WHEN 创建外键约束时 THEN 系统 SHALL 正确建立表之间的关联关系
6. WHEN 表结构需要更新时 THEN 系统 SHALL 支持版本化的表结构迁移
7. WHEN 表创建失败时 THEN 系统 SHALL 记录详细的错误信息并回滚已创建的表

---

### 需求 4：数据迁移工具开发

**用户故事：** 作为一名【系统管理员】，我希望【有一个专门的工具将 SQLite 数据迁移到 MySQL】，以便【完整保留现有数据且操作简单】。

#### 验收标准

1. WHEN 执行迁移工具时 THEN 系统 SHALL 读取 SQLite 数据库中的所有表数据
2. WHEN 迁移数据时 THEN 系统 SHALL 按正确的顺序迁移表（先迁移主表，再迁移从表）
3. WHEN 迁移数据时 THEN 系统 SHALL 将 SQLite 的时间字符串格式转换为 MySQL 的 DATETIME 格式
4. WHEN 迁移包含外键的数据时 THEN 系统 SHALL 先迁移被引用的表数据
5. WHEN 迁移过程中发生错误时 THEN 系统 SHALL 记录错误详情并提供继续或回滚选项
6. WHEN 数据迁移完成时 THEN 系统 SHALL 显示迁移统计信息（成功/失败的记录数）
7. WHEN 迁移数据时 THEN 系统 SHALL 支持进度显示，方便用户了解迁移进度
8. WHEN 迁移大量数据时 THEN 系统 SHALL 使用批量插入以提高性能
9. IF 迁移前 MySQL 表中已有数据 THEN 系统 SHALL 提示用户选择覆盖或跳过

---

### 需求 5：数据验证和一致性检查

**用户故事：** 作为一名【系统管理员】，我希望【迁移后能够验证数据的完整性】，以便【确保迁移过程没有数据丢失或损坏】。

#### 验收标准

1. WHEN 数据迁移完成时 THEN 系统 SHALL 对比 SQLite 和 MySQL 中的记录数量
2. WHEN 发现记录数量不一致时 THEN 系统 SHALL 报告具体哪些表的记录数不匹配
3. WHEN 验证数据时 THEN 系统 SHALL 抽样对比关键字段的内容
4. WHEN 发现数据内容不一致时 THEN 系统 SHALL 记录差异详情
5. WHEN 验证通过时 THEN 系统 SHALL 生成验证报告并保存到指定目录
6. WHEN 验证失败时 THEN 系统 SHALL 提供修复建议或自动回滚选项
7. WHEN 验证完成后 THEN 系统 SHALL 显示验证结果的摘要信息

---

### 需求 6：迁移回滚机制

**用户故事：** 作为一名【系统管理员】，我希望【如果迁移失败可以选择回滚到 SQLite】，以便【保证系统的可用性】。

#### 验收标准

1. WHEN 执行迁移前 THEN 系统 SHALL 备份 SQLite 数据库文件
2. WHEN 迁移过程中发生严重错误时 THEN 系统 SHALL 询问用户是否回滚
3. WHEN 用户选择回滚时 THEN 系统 SHALL 恢复 SQLite 数据库配置
4. WHEN 回滚时 THEN 系统 SHALL 清理 MySQL 中已迁移的数据（可选）
5. WHEN 回滚完成时 THEN 系统 SHALL 确认系统可以正常运行
6. WHEN 回滚失败时 THEN 系统 SHALL 提供手动恢复步骤的文档

---

### 需求 7：性能优化

**用户故事：** 作为一名【开发者】，我希望【迁移后的 MySQL 数据库具有良好的性能】，以便【支持更多的并发访问和更快的查询速度】。

#### 验收标准

1. WHEN 创建表时 THEN 系统 SHALL 为所有外键和常用查询条件创建索引
2. WHEN 查询数据时 THEN 系统 SHALL 使用连接池管理数据库连接
3. WHEN 执行批量插入时 THEN 系统 SHALL 使用批量操作而非单条插入
4. WHEN 查询大量数据时 THEN 系统 SHALL 支持分页查询
5. WHEN 数据库连接数超过配置阈值时 THEN 系统 SHALL 实现连接等待和超时机制
6. WHEN 执行复杂查询时 THEN 系统 SHALL 优化查询语句（避免 SELECT * 等）

---

### 需求 8：日志和监控

**用户故事：** 作为一名【运维人员】，我希望【能够监控 MySQL 数据库的运行状态】，以便【及时发现和解决问题】。

#### 验收标准

1. WHEN 执行数据库操作时 THEN 系统 SHALL 记录详细的操作日志（包括查询语句、执行时间、影响行数）
2. WHEN 数据库操作失败时 THEN 系统 SHALL 记录错误堆栈信息
3. WHEN 数据库连接失败时 THEN 系统 SHALL 发送告警通知
4. WHEN 数据库查询响应时间超过阈值时 THEN 系统 SHALL 记录慢查询日志
5. WHEN 数据库连接数接近上限时 THEN 系统 SHALL 记录警告日志
6. WHEN 迁移工具执行时 THEN 系统 SHALL 记录迁移进度和关键事件

---

### 需求 9：文档更新

**用户故事：** 作为一名【开发者】，我希望【有完整的迁移文档和操作指南】，以便【其他人员可以理解和维护这个迁移功能】。

#### 验收标准

1. WHEN 迁移功能开发完成时 THEN 系统 SHALL 提供详细的数据库 Schema 文档（MySQL 版本）
2. WHEN 迁移工具开发完成时 THEN 系统 SHALL 提供工具使用说明文档
3. WHEN 配置项修改时 THEN 系统 SHALL 更新配置文档
4. WHEN 迁移完成后 THEN 系统 SHALL 生成迁移报告文档
5. WHEN 需要回滚时 THEN 系统 SHALL 提供回滚操作指南

---

### 需求 10：兼容性和向后兼容

**用户故事：** 作为一名【系统管理员】，我希望【能够灵活选择使用 SQLite 或 MySQL】，以便【在开发环境使用 SQLite，生产环境使用 MySQL】。

#### 验收标准

1. WHEN 配置文件中指定数据库类型为 SQLite 时 THEN 系统 SHALL 使用 SQLiteDB
2. WHEN 配置文件中指定数据库类型为 MySQL 时 THEN 系统 SHALL 使用 MySQLDB
3. WHEN 切换数据库类型时 THEN 系统 SHALL 提供统一的数据访问接口
4. WHEN 使用不同的数据库时 THEN 系统 SHALL 保证业务逻辑代码无需修改
5. WHEN 数据库初始化时 THEN 系统 SHALL 根据配置自动选择对应的数据库适配器

---

## 数据迁移范围

### 需要迁移的数据表

1. **stocks** - 股票基础信息（约 5000+ 条记录）
2. **strategies** - 策略配置（约 5-10 条记录）
3. **strategy_results** - 策略执行结果（可能有数万条记录）
4. **system_logs** - 系统日志（可能有数万条记录）
5. **data_update_history** - 数据更新历史（约数十条记录）
6. **job_logs** - 定时任务日志（可能有数百条记录）
7. **task_execution_details** - 任务执行详情（可能有数万条记录）

### 数据类型映射

| SQLite 类型 | MySQL 8.0 类型 | 说明 |
|-------------|----------------|------|
| TEXT (主键) | VARCHAR(20) | 股票代码、短文本 |
| TEXT (普通) | VARCHAR(500) | 中等长度文本 |
| TEXT (JSON) | TEXT | JSON 数据，使用 TEXT 存储 |
| INTEGER | INT | 整数 |
| REAL | DECIMAL(10,4) | 浮点数，保留 4 位小数 |
| (无) | DATETIME | 时间格式 |

### 字符集和排序规则

- **字符集**: utf8mb4（支持完整的 Unicode，包括 emoji）
- **排序规则**: utf8mb4_unicode_ci（不区分大小写，适合多语言）

---

## 非功能性需求

### 性能要求

1. 数据迁移工具应在 10 分钟内完成 10 万条记录的迁移
2. 数据库查询响应时间应在 100ms 以内（普通查询）
3. 数据库连接池应支持至少 50 个并发连接

### 安全要求

1. 数据库密码不得明文存储在配置文件中，应使用环境变量或加密配置
2. 数据库用户应遵循最小权限原则
3. 迁移过程中应保证数据的完整性和一致性

### 可靠性要求

1. 迁移工具应支持断点续传
2. 迁移失败后应能够回滚到迁移前状态
3. 系统应能够优雅地处理数据库连接中断

---

## 技术选型

### 数据库驱动

- **PyMySQL**: 纯 Python 实现的 MySQL 客户端，无需安装 C 库
- **MySQL Connector/Python**: 官方 MySQL 驱动（可选）

### 连接池

- **DBUtils**: 提供数据库连接池功能

### 数据验证

- 使用抽样验证和全量验证相结合的方式

---

## 风险和限制

### 主要风险

1. **数据丢失风险**: 迁移过程中可能出现数据丢失
   - 缓解措施: 迁移前备份、迁移后验证、支持回滚

2. **兼容性风险**: SQLite 和 MySQL 在 SQL 语法上存在差异
   - 缓解措施: 使用抽象层统一接口、充分测试

3. **性能风险**: 大量数据迁移可能耗时较长
   - 缓解措施: 使用批量插入、进度显示、支持断点续传

### 已知限制

1. 需要预先安装 MySQL 8.0 服务器
2. 需要配置 MySQL 用户和权限
3. 迁移期间系统可能需要短暂停机
4. 某些 SQLite 特有功能在 MySQL 中可能无法直接实现

---

## 验收标准总结

1. ✅ MySQL 数据库适配器提供与 SQLiteDB 相同的 API 接口
2. ✅ 所有 7 个数据表正确迁移到 MySQL
3. ✅ 数据验证通过，记录数和内容一致
4. ✅ 迁移工具能够独立运行并提供清晰的进度反馈
5. ✅ 支持配置切换数据库类型（SQLite/MySQL）
6. ✅ 提供完整的文档和使用指南
7. ✅ 系统迁移后功能正常，无数据丢失
8. ✅ 支持迁移回滚机制

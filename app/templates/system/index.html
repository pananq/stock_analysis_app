{% extends "base.html" %}

{% block title %}系统设置 - 股票分析系统{% endblock %}

{% block content %}
<style>
.config-section {
    margin-bottom: 20px;
}
.config-section h6 {
    margin-bottom: 15px;
    color: #495057;
    font-weight: 600;
}
.db-status-healthy {
    color: #198754;
}
.db-status-error {
    color: #dc3545;
}
</style>

<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-cog"></i> 系统设置</h2>
        <hr>
    </div>
</div>

{% if error %}
<div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle"></i> {{ error }}
</div>
{% endif %}

<!-- 系统信息展示 -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-info-circle"></i> 系统信息
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <th width="40%">系统名称</th>
                        <td>股票分析系统</td>
                    </tr>
                    <tr>
                        <th>版本</th>
                        <td><span class="badge bg-primary">v1.0.0</span></td>
                    </tr>
                    <tr>
                        <th>数据源</th>
                        <td>
                            <span class="badge bg-success">{{ system_config.get('datasource', {}).get('type', '-') }}</span>
                        </td>
                    </tr>
                    <tr>
                        <th>数据范围</th>
                        <td>
                            {% if market_stats.get('earliest_date') %}
                            {{ market_stats.get('earliest_date') }} 至 
                            {{ market_stats.get('latest_date') }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    
    <!-- 调度任务 -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-clock"></i> 调度任务
            </div>
            <div class="card-body">
                {% if jobs %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>任务名称</th>
                                <th>下次执行</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for job in jobs %}
                            <tr>
                                <td>
                                    <i class="fas fa-check-circle text-success"></i>
                                    {{ job.name }}
                                </td>
                                <td>
                                    <small>{{ job.next_run_time or '-' }}</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state text-center py-4">
                    <i class="fas fa-clock text-muted mb-2"></i>
                    <p class="mb-0">暂无调度任务</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-database"></i> 数据库状态
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <th width="40%">主数据库</th>
                        <td>
                            {% set main_db = database_status.get('main_database', {}) %}
                            <span class="badge bg-{{ 'success' if main_db.get('status') == 'healthy' else 'danger' }}">
                                {{ main_db.get('type', 'unknown') }} - {{ main_db.get('status', 'unknown') }}
                            </span>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 系统级配置（仅显示） -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-server"></i> 系统服务配置（只读）
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6>API 服务</h6>
                        <table class="table table-sm">
                            <tr>
                                <th>端口</th>
                                <td><span class="badge bg-info">{{ system_info_config.get('api', {}).get('port', 5000) }}</span></td>
                            </tr>
                            <tr>
                                <th>主机</th>
                                <td>{{ system_info_config.get('api', {}).get('host', '0.0.0.0') }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-4">
                        <h6>Web 服务</h6>
                        <table class="table table-sm">
                            <tr>
                                <th>端口</th>
                                <td><span class="badge bg-info">{{ system_info_config.get('web', {}).get('port', 8000) }}</span></td>
                            </tr>
                            <tr>
                                <th>调试模式</th>
                                <td>
                                    {% if system_info_config.get('web', {}).get('debug', False) %}
                                    <span class="badge bg-warning">开启</span>
                                    {% else %}
                                    <span class="badge bg-secondary">关闭</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-4">
                        <h6>日志配置</h6>
                        <table class="table table-sm">
                            <tr>
                                <th>日志级别</th>
                                <td>
                                    <span class="badge bg-primary">
                                        {{ system_info_config.get('logging', {}).get('level', 'INFO') }}
                                    </span>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 应用配置（仅显示） -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-sliders-h"></i> 应用配置（只读）
            </div>
            <div class="card-body">
                <!-- 应用模式 -->
                <div class="config-section">
                    <h6><i class="fas fa-code"></i> 应用模式</h6>
                    <table class="table table-sm">
                        <tr>
                            <th width="30%">运行模式</th>
                            <td>
                                {% if system_config.get('app_mode', {}).get('mode') == 'production' %}
                                <span class="badge bg-success">生产模式</span>
                                {% else %}
                                <span class="badge bg-warning">开发模式</span>
                                {% endif %}
                                <small class="text-muted ml-2">
                                    {% if system_config.get('app_mode', {}).get('mode') == 'production' %}
                                    处理全部股票
                                    {% else %}
                                    仅处理{{ system_config.get('app_mode', {}).get('development_stock_limit', 100) }}支股票
                                    {% endif %}
                                </small>
                            </td>
                        </tr>
                        <tr>
                            <th>开发模式股票数量限制</th>
                            <td>{{ system_config.get('app_mode', {}).get('development_stock_limit', 100) }} 支</td>
                        </tr>
                    </table>
                </div>

                <!-- 数据源 -->
                <div class="config-section">
                    <h6><i class="fas fa-database"></i> 数据源</h6>
                    <table class="table table-sm">
                        <tr>
                            <th width="30%">数据源类型</th>
                            <td>
                                <span class="badge bg-{{ 'info' if system_config.get('datasource', {}).get('type') == 'akshare' else 'primary' }}">
                                    {{ system_config.get('datasource', {}).get('type', 'akshare')|upper }}
                                </span>
                            </td>
                        </tr>
                    </table>
                </div>

                <!-- API 频率限制 -->
                <div class="config-section">
                    <h6><i class="fas fa-tachometer-alt"></i> API 频率限制</h6>
                    <table class="table table-sm">
                        <tr>
                            <th width="30%">最小延迟</th>
                            <td>{{ system_config.get('api_rate_limit', {}).get('min_delay', 1.5) }} 秒</td>
                        </tr>
                        <tr>
                            <th>最大延迟</th>
                            <td>{{ system_config.get('api_rate_limit', {}).get('max_delay', 2.0) }} 秒</td>
                        </tr>
                        <tr>
                            <th>最大重试次数</th>
                            <td>{{ system_config.get('api_rate_limit', {}).get('max_retries', 3) }} 次</td>
                        </tr>
                        <tr>
                            <th>重试延迟增量</th>
                            <td>{{ system_config.get('api_rate_limit', {}).get('retry_delay_increment', 1.0) }} 秒</td>
                        </tr>
                    </table>
                </div>

                <!-- 任务调度 -->
                <div class="config-section">
                    <h6><i class="fas fa-clock"></i> 任务调度</h6>
                    <table class="table table-sm">
                        <tr>
                            <th width="30%">启用自动更新</th>
                            <td>
                                {% if system_config.get('scheduler', {}).get('enable_auto_update') == True %}
                                <span class="badge bg-success"><i class="fas fa-check"></i> 已启用</span>
                                {% else %}
                                <span class="badge bg-secondary"><i class="fas fa-times"></i> 未启用</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>股票列表更新时间</th>
                            <td>{{ system_config.get('scheduler', {}).get('stock_list_update_time', '18:00') }}</td>
                        </tr>
                        <tr>
                            <th>行情数据更新时间</th>
                            <td>{{ system_config.get('scheduler', {}).get('market_data_update_time', '18:30') }}</td>
                        </tr>
                    </table>
                </div>

                <!-- 数据管理 -->
                <div class="config-section">
                    <h6><i class="fas fa-hdd"></i> 数据管理</h6>
                    <table class="table table-sm">
                        <tr>
                            <th width="30%">数据保留年限</th>
                            <td>{{ system_config.get('data_management', {}).get('data_retention_years', 5) }} 年</td>
                        </tr>
                        <tr>
                            <th>启用自动备份</th>
                            <td>
                                {% if system_config.get('data_management', {}).get('enable_auto_backup') == True %}
                                <span class="badge bg-success"><i class="fas fa-check"></i> 已启用</span>
                                {% else %}
                                <span class="badge bg-secondary"><i class="fas fa-times"></i> 未启用</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>备份保留天数</th>
                            <td>{{ system_config.get('data_management', {}).get('backup_retention_days', 30) }} 天</td>
                        </tr>
                    </table>
                </div>

                <!-- 策略默认值 -->
                <div class="config-section">
                    <h6><i class="fas fa-chart-line"></i> 策略默认值</h6>
                    <table class="table table-sm">
                        <tr>
                            <th width="30%">默认涨幅阈值</th>
                            <td>{{ system_config.get('strategy_defaults', {}).get('rise_threshold', 8.0) }} %</td>
                        </tr>
                        <tr>
                            <th>默认观察天数</th>
                            <td>{{ system_config.get('strategy_defaults', {}).get('observation_days', 3) }} 天</td>
                        </tr>
                        <tr>
                            <th>默认均线周期</th>
                            <td>{{ system_config.get('strategy_defaults', {}).get('ma_period', 5) }} 天</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 快捷链接 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-link"></i> 快捷链接
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 col-sm-6 mb-3">
                        <a href="/system/logs" class="btn btn-outline-primary btn-lg w-100">
                            <i class="fas fa-file-alt"></i><br>
                            <small>系统日志</small>
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <a href="/system/tasks" class="btn btn-outline-success btn-lg w-100">
                            <i class="fas fa-tasks"></i><br>
                            <small>任务历史</small>
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <a href="/data" class="btn btn-outline-info btn-lg w-100">
                            <i class="fas fa-database"></i><br>
                            <small>数据管理</small>
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <button class="btn btn-outline-warning btn-lg w-100" onclick="location.reload()">
                            <i class="fas fa-sync-alt"></i><br>
                            <small>刷新页面</small>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 系统设置页面 - 仅显示，不需要 JavaScript 交互逻辑
</script>
{% endblock %}

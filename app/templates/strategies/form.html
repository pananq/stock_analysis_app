{% extends "base.html" %}

{% block title %}{% if strategy_id %}编辑策略{% else %}创建策略{% endif %} - 股票分析系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2>
                <i class="fas fa-brain"></i> 
                {% if strategy_id %}编辑策略{% else %}创建策略{% endif %}
            </h2>
            <a href="/strategies" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> 返回列表
            </a>
        </div>
        <hr>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                {% if error %}
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i> {{ error }}
                </div>
                {% endif %}
                
                <form id="strategyForm" class="strategy-form">
                    <!-- 策略名称 -->
                    <div class="mb-3">
                        <label for="name" class="form-label">
                            <i class="fas fa-tag"></i> 策略名称 <span class="text-danger">*</span>
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="name" 
                               name="name" 
                               required
                               value="{{ strategy.name if strategy else '' }}"
                               placeholder="例如：均线突破策略">
                        <div class="form-text">给策略起一个有意义的名称</div>
                    </div>
                    
                    <!-- 策略描述 -->
                    <div class="mb-3">
                        <label for="description" class="form-label">
                            <i class="fas fa-align-left"></i> 策略描述
                        </label>
                        <textarea class="form-control" 
                                  id="description" 
                                  name="description" 
                                  rows="3"
                                  placeholder="描述该策略的投资逻辑和适用场景">{{ strategy.description if strategy else '' }}</textarea>
                        <div class="form-text">简要说明策略的原理和目标</div>
                    </div>
                    
                    <hr>
                    <h5><i class="fas fa-cogs"></i> 策略参数</h5>
                    <p class="text-muted mb-3">配置策略的筛选条件</p>
                    
                    <!-- 涨幅阈值 -->
                    <div class="mb-3">
                        <label for="rise_threshold" class="form-label">
                            <i class="fas fa-arrow-up"></i> 涨幅阈值 (%)
                        </label>
                        <div class="input-group">
                            <input type="number" 
                                   class="form-control" 
                                   id="rise_threshold" 
                                   name="rise_threshold" 
                                   step="0.1"
                                   min="0"
                                   value="{{ strategy.config.min_change if strategy else 8.0 }}">
                            <span class="input-group-text">%</span>
                        </div>
                        <div class="form-text">筛选单日涨幅超过此阈值的股票</div>
                    </div>
                    
                    <!-- 观察天数 -->
                    <div class="mb-3">
                        <label for="observation_days" class="form-label">
                            <i class="fas fa-calendar-alt"></i> 观察天数
                        </label>
                        <div class="input-group">
                            <input type="number" 
                                   class="form-control" 
                                   id="observation_days" 
                                   name="observation_days" 
                                   min="1"
                                   max="365"
                                   value="{{ strategy.config.days if strategy else 3 }}">
                            <span class="input-group-text">天</span>
                        </div>
                        <div class="form-text">大涨后观察多少天，要求每天收盘价都在均线之上</div>
                    </div>
                    
                    <!-- 均线周期 -->
                    <div class="mb-3">
                        <label for="ma_period" class="form-label">
                            <i class="fas fa-chart-line"></i> 均线周期
                        </label>
                        <div class="input-group">
                            <input type="number" 
                                   class="form-control" 
                                   id="ma_period" 
                                   name="ma_period" 
                                   min="5"
                                   max="120"
                                   value="{{ strategy.config.ma_period if strategy else 5 }}">
                            <span class="input-group-text">日</span>
                        </div>
                        <div class="form-text">移动平均线的周期（常用：5、10、20、60日均线）</div>
                    </div>
                    
                    <hr>
                    
                    <!-- 启用状态 -->
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   id="enabled" 
                                   name="enabled"
                                   {% if strategy is none or strategy.enabled %}checked{% endif %}>
                            <label class="form-check-label" for="enabled">
                                <i class="fas fa-power-off"></i> 启用策略
                            </label>
                            <div class="form-text">禁用的策略不会被执行</div>
                        </div>
                    </div>
                    
                    <!-- 提交按钮 -->
                    <div class="d-flex justify-content-end gap-2">
                        <a href="/strategies" class="btn btn-secondary">
                            <i class="fas fa-times"></i> 取消
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> {% if strategy_id %}更新策略{% else %}创建策略{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 策略说明 -->
        <div class="card mt-3">
            <div class="card-header">
                <i class="fas fa-info-circle"></i> 策略说明
            </div>
            <div class="card-body">
                <h6>筛选条件</h6>
                <ul>
                    <li><strong>涨幅阈值：</strong>股票单日涨幅必须超过此值</li>
                    <li><strong>观察天数：</strong>大涨后连续N天收盘价在均线之上</li>
                    <li><strong>均线周期：</strong>计算N日移动平均线作为参考</li>
                </ul>
                <h6>执行流程</h6>
                <ol>
                    <li>扫描所有股票的历史行情数据</li>
                    <li>计算指定周期的移动平均线</li>
                    <li>筛选出现大涨（超过阈值）的日期</li>
                    <li>检查大涨后N天内是否一直保持在均线之上</li>
                    <li>返回符合条件的股票</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
/**
 * 表单验证与提交
 */
document.getElementById('strategyForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // 获取表单值
    const name = document.getElementById('name').value;
    const description = document.getElementById('description').value;
    const riseThreshold = parseFloat(document.getElementById('rise_threshold').value);
    const observationDays = parseInt(document.getElementById('observation_days').value);
    const maPeriod = parseInt(document.getElementById('ma_period').value);
    const enabled = document.getElementById('enabled').checked;
    
    // 验证
    if (!name) {
        showMessage('请输入策略名称', 'danger');
        return;
    }
    
    if (riseThreshold <= 0) {
        showMessage('涨幅阈值必须大于0', 'danger');
        return;
    }
    
    if (observationDays < 1 || observationDays > 365) {
        showMessage('观察天数必须在1-365之间', 'danger');
        return;
    }
    
    if (maPeriod < 5 || maPeriod > 120) {
        showMessage('均线周期必须在5-120之间', 'danger');
        return;
    }
    
    // 构造数据
    const data = {
        name: name,
        description: description,
        rise_threshold: riseThreshold,
        observation_days: observationDays,
        ma_period: maPeriod,
        enabled: enabled
    };
    
    // 提交
    const isEdit = {% if strategy_id %}true{% else %}false{% endif %};
    const url = isEdit ? `/strategies/{{ strategy_id }}` : '/strategies';
    const method = isEdit ? 'PUT' : 'POST';
    const loadingMsg = isEdit ? '正在更新策略...' : '正在创建策略...';
    
    showLoading(loadingMsg, false);
    
    apiRequest(url, method, data,
        function(response) {
            hideLoading();
            showMessage(isEdit ? '策略更新成功' : '策略创建成功', 'success');
            setTimeout(function() {
                window.location.href = '/strategies';
            }, 1000);
        },
        function(response) {
            // apiRequest 函数已经显示了错误信息，这里只需要关闭加载弹窗
            hideLoading();
        }
    );
});
</script>
{% endblock %}

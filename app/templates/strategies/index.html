{% extends "base.html" %}

{% block title %}策略管理 - 股票分析系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="fas fa-brain"></i> 策略管理</h2>
            <a href="/strategies/create" class="btn btn-primary">
                <i class="fas fa-plus"></i> 创建策略
            </a>
        </div>
        <hr>
    </div>
</div>

<!-- 统计信息 -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <small class="text-muted">策略总数</small>
                        <h3>{{ stats.get('total', 0) }}</h3>
                    </div>
                    <div class="text-primary" style="font-size: 2rem;">
                        <i class="fas fa-layer-group"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <small class="text-muted">已启用</small>
                        <h3 class="text-success">{{ stats.get('enabled', 0) }}</h3>
                    </div>
                    <div class="text-success" style="font-size: 2rem;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <small class="text-muted">已禁用</small>
                        <h3 class="text-secondary">{{ stats.get('disabled', 0) }}</h3>
                    </div>
                    <div class="text-secondary" style="font-size: 2rem;">
                        <i class="fas fa-ban"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 策略列表 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-list"></i> 策略列表
            </div>
            <div class="card-body">
                {% if error %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> {{ error }}
                </div>
                {% endif %}
                
                {% if strategies %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th width="5%">ID</th>
                                <th width="20%">策略名称</th>
                                <th width="35%">策略配置</th>
                                <th width="10%">状态</th>
                                <th width="15%">最后执行</th>
                                <th width="15%">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for strategy in strategies %}
                            <tr>
                                <td>{{ strategy.id }}</td>
                                <td>
                                    <a href="/strategies/{{ strategy.id }}" class="text-decoration-none">
                                        <strong>{{ strategy.name }}</strong>
                                    </a>
                                    {% if strategy.description %}
                                    <br><small class="text-muted">{{ strategy.description }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>
                                        <strong>涨幅阈值:</strong> 
                                        {{ strategy.config.rise_threshold }}%
                                        <br>
                                        <strong>观察天数:</strong> {{ strategy.config.observation_days }}天
                                        <br>
                                        <strong>均线周期:</strong> {{ strategy.config.ma_period }}日
                                    </small>
                                </td>
                                <td>
                                    {% if strategy.enabled %}
                                    <span class="badge bg-success">启用</span>
                                    {% else %}
                                    <span class="badge bg-secondary">禁用</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if strategy.last_executed_at %}
                                    <small>{{ strategy.last_executed_at | datetime }}</small>
                                    {% else %}
                                    <small class="text-muted">未执行</small>
                                    {% endif %}
                                </td>
                                <td class="table-actions">
                                    <button class="btn btn-sm btn-success" 
                                            onclick="executeStrategy({{ strategy.id }})"
                                            title="执行策略">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <a href="/strategies/{{ strategy.id }}" 
                                       class="btn btn-sm btn-info"
                                       title="查看详情">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="/strategies/{{ strategy.id }}/edit" 
                                       class="btn btn-sm btn-primary"
                                       title="编辑策略">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button class="btn btn-sm btn-danger"
                                            onclick="deleteStrategy({{ strategy.id }}, '{{ strategy.name }}')"
                                            title="删除策略">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-brain"></i>
                    <h5>暂无策略</h5>
                    <p>点击"创建策略"按钮开始创建您的第一个策略</p>
                    <a href="/strategies/create" class="btn btn-primary">
                        <i class="fas fa-plus"></i> 创建策略
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 任务轮询定时器
let taskPollTimer = null;

/**
 * 执行策略
 */
function executeStrategy(strategyId) {
    showConfirm('确定要执行该策略吗？执行将在后台进行，完成后会通知您。', function() {
        showLoading('正在创建执行任务...', false);
        
        apiRequest(`/strategies/${strategyId}/execute`, 'POST', {},
            function(response) {
                hideLoading();
                const taskId = response.data.task_id;
                showMessage('策略执行任务已创建，正在后台执行...', 'info');
                
                // 开始轮询任务状态
                pollTaskStatus(taskId);
            },
            function(error) {
                hideLoading();
            }
        );
    });
}

/**
 * 轮询任务状态
 */
function pollTaskStatus(taskId) {
    // 清除之前的定时器
    if (taskPollTimer) {
        clearInterval(taskPollTimer);
    }
    
    // 显示进度提示
    showLoading('策略执行中，请稍候...', false);
    
    // 每2秒查询一次任务状态
    taskPollTimer = setInterval(function() {
        apiRequest(`/strategies/tasks/${taskId}`, 'GET', null,
            function(response) {
                const task = response.data;
                
                // 更新进度消息
                if (task.status === 'running') {
                    const progressMsg = `执行中... ${task.progress.toFixed(0)}% - ${task.message}`;
                    showLoading(progressMsg, false);
                } else if (task.status === 'completed') {
                    // 任务完成
                    clearInterval(taskPollTimer);
                    taskPollTimer = null;
                    hideLoading();
                    
                    // 显示结果
                    if (task.result && task.result.success) {
                        const result = task.result;
                        showMessage(
                            `策略执行完成！<br>` +
                            `扫描股票: ${result.scanned_stocks} 只<br>` +
                            `匹配股票: ${result.matched_count} 只<br>` +
                            `耗时: ${result.execution_time.toFixed(1)} 秒`,
                            'success'
                        );
                        
                        // 1.5秒后刷新页面
                        setTimeout(refreshPage, 1500);
                    } else {
                        showMessage('策略执行完成，但未返回结果', 'warning');
                        setTimeout(refreshPage, 1500);
                    }
                } else if (task.status === 'failed') {
                    // 任务失败
                    clearInterval(taskPollTimer);
                    taskPollTimer = null;
                    hideLoading();
                    showMessage(`策略执行失败: ${task.error || '未知错误'}`, 'error');
                }
            },
            function(error) {
                // 查询失败，停止轮询
                clearInterval(taskPollTimer);
                taskPollTimer = null;
                hideLoading();
                showMessage('无法获取任务状态', 'error');
            }
        );
    }, 2000);
}

// 页面卸载时清除定时器
window.addEventListener('beforeunload', function() {
    if (taskPollTimer) {
        clearInterval(taskPollTimer);
    }
});

/**
 * 删除策略
 */
function deleteStrategy(strategyId, strategyName) {
    showConfirm(`确定要删除策略"${strategyName}"吗？删除后无法恢复。`, function() {
        // 使用表单提交进行删除
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/strategies/${strategyId}/delete`;
        document.body.appendChild(form);
        form.submit();
    });
}
</script>
{% endblock %}

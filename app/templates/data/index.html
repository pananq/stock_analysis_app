{% extends "base.html" %}

{% block title %}数据管理 - 股票分析系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-database"></i> 数据管理</h2>
        <hr>
    </div>
</div>

{% if error %}
<div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle"></i> {{ error }}
</div>
{% endif %}

<!-- 数据统计 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card" style="height: 120px;">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <small class="text-muted">股票总数</small>
                        <h3 id="total-stocks">{{ status.get('total_stocks', 0) }}</h3>
                    </div>
                    <div class="text-primary" style="font-size: 2rem;">
                        <i class="fas fa-list"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card" style="height: 120px;">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <small class="text-muted">行情记录</small>
                        <h3 id="total-records">{{ status.get('record_count_millions', 0) }}万</h3>
                    </div>
                    <div class="text-success" style="font-size: 2rem;">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card" style="height: 120px;">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <small class="text-muted">数据日期范围</small>
                        <div class="mt-2" id="date-range" style="font-size: 0.85rem; line-height: 1.3;">
                            {% if status.get('earliest_date') %}
                            {{ status.earliest_date[:4] }}/{{ status.earliest_date[4:6] }}/{{ status.earliest_date[6:] }}
                            <br>
                            至
                            <br>
                            {{ status.latest_date[:4] }}/{{ status.latest_date[4:6] }}/{{ status.latest_date[6:] }}
                            {% else %}
                            -
                            {% endif %}
                        </div>
                    </div>
                    <div class="text-info" style="font-size: 2rem;">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card" style="height: 120px;">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <small class="text-muted">当前任务</small>
                        <div class="mt-2" id="current-task" style="font-size: 1rem;">
                            无
                        </div>
                    </div>
                    <div class="text-warning" style="font-size: 2rem;">
                        <i class="fas fa-tasks"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 数据操作 -->
<div class="row">
    <!-- 第一行 -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-download"></i> 股票列表导入
            </div>
            <div class="card-body d-flex flex-column">
                <p class="text-muted flex-grow-1">
                    从数据源获取全量股票列表信息，将完全替换数据库中的现有股票数据。
                    适用于首次导入或需要更新全量股票列表时使用。
                </p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>注意：</strong>此操作将删除现有股票列表并用新数据替换！
                </div>
                <button class="btn btn-primary w-100" onclick="importStockList()" id="btn-import-stock-list">
                    <i class="fas fa-download"></i> 导入股票列表
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-info text-white">
                <i class="fas fa-sync-alt"></i> 股票列表更新
            </div>
            <div class="card-body d-flex flex-column">
                <p class="text-muted flex-grow-1">
                    增量更新股票列表，保留现有数据，只更新变化的部分。
                    建议定期执行以保持股票信息最新。
                </p>
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> 
                    <strong>推荐：</strong>定期执行，不会影响现有数据
                </div>
                <button class="btn btn-info w-100" onclick="updateStockList()" id="btn-update-stock-list">
                    <i class="fas fa-sync-alt"></i> 更新股票列表
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 第二行 -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-dark text-white">
                <i class="fas fa-database"></i> 全量数据导入
            </div>
            <div class="card-body d-flex flex-column">
                <p class="text-muted flex-grow-1">
                    从数据源获取所有股票的历史行情数据。
                    首次使用时建议执行此操作，后续可以使用增量更新功能。
                </p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    <strong>注意：</strong>全量导入将在后台执行，你可以关闭页面，任务会继续运行。
                </div>
                <button class="btn btn-dark w-100" onclick="importData()" id="btn-import">
                    <i class="fas fa-download"></i> 开始全量导入
                </button>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <i class="fas fa-sync-alt"></i> 行情数据更新
            </div>
            <div class="card-body d-flex flex-column">
                <p class="text-muted flex-grow-1">
                    更新股票的最新一日的行情数据。
                    建议每日收盘后执行此操作以保持数据最新。
                </p>
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> 
                    <strong>推荐：</strong>每日执行一次，耗时较短
                </div>
                <button class="btn btn-success w-100" onclick="updateData()" id="btn-update">
                    <i class="fas fa-sync-alt"></i> 更新行情数据
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 任务进度显示 -->
<div class="row" id="task-progress-section" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-tasks"></i> 导入任务进度</span>
                <div class="d-flex align-items-center">
                    <span id="task-status-badge" class="badge bg-info me-2">运行中</span>
                    <button id="btn-cancel-task" class="btn btn-sm btn-danger" onclick="cancelTask()" style="display: none;">
                        <i class="fas fa-stop"></i> 取消任务
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span id="task-message">正在导入数据...</span>
                        <span id="task-percentage">0%</span>
                    </div>
                    <div class="progress" style="height: 30px;">
                        <div id="task-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="text-muted">
                    <small>
                        <i class="fas fa-clock"></i> 开始时间：<span id="task-start-time">-</span> | 
                        <i class="fas fa-stopwatch"></i> 任务ID：<span id="task-id-display">-</span>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 数据源状态 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-plug"></i> 数据源状态
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5>Akshare</h5>
                                <p class="text-muted">开源金融数据接口</p>
                                {% if datasource.akshare %}
                                <span class="badge bg-info">可用</span>
                                {% else %}
                                <span class="badge bg-danger">不可用</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5>Tushare</h5>
                                <p class="text-muted">专业金融数据接口</p>
                                {% if datasource.tushare %}
                                <span class="badge bg-success">已配置</span>
                                {% else %}
                                <span class="badge bg-secondary">未配置</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5>当前数据源</h5>
                                <p class="text-muted">系统使用的数据源</p>
                                {% if datasource.current_datasource == 'tushare' and datasource.tushare %}
                                <span class="badge bg-primary">Tushare</span>
                                {% else %}
                                <span class="badge bg-primary">Akshare</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 使用说明 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-book"></i> 使用说明
            </div>
            <div class="card-body">
                <h6>数据更新流程</h6>
                <ol>
                    <li><strong>首次使用：</strong>执行"全量数据导入"，获取所有股票的基础信息和历史行情</li>
                    <li><strong>日常使用：</strong>每日收盘后执行"增量数据更新"，获取最新行情</li>
                    <li><strong>数据范围：</strong>系统自动记录所有A股股票的历史行情数据</li>
                    <li><strong>定时更新：</strong>可以配置自动任务，每日自动执行增量更新</li>
                </ol>
                
                <h6>注意事项</h6>
                <ul>
                    <li>数据更新需要稳定的网络连接</li>
                    <li>全量导入可能需要数小时时间，请耐心等待</li>
                    <li>增量更新通常在几分钟内完成</li>
                    <li>如遇数据源API限制，系统会自动延迟重试</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 当前任务ID和定时器
let currentTaskId = null;
let taskCheckInterval = null;

/**
 * 导入股票列表（全量替换）
 */
function importStockList() {
    showConfirm('确定要导入全量股票列表吗？此操作将完全替换数据库中的现有股票数据，不可恢复！', function() {
        // 显示加载遮罩
        showLoading('正在导入股票列表，请稍候...');
        
        apiRequest('/stocks/list/import', 'POST', {},
            function(response) {
                hideLoading();
                if (response.success) {
                    const message = `股票列表导入成功！\n总数：${response.data.total}\n成功：${response.data.success_count}\n失败：${response.data.fail_count}\n耗时：${response.data.duration.toFixed(2)}秒`;
                    showMessage(message, 'success');
                    // 刷新数据统计
                    refreshDataStatus();
                } else {
                    showMessage('导入股票列表失败: ' + response.error, 'error');
                }
            },
            function(error) {
                hideLoading();
                showMessage('导入股票列表失败: ' + error, 'error');
            }
        );
    });
}

/**
 * 更新股票列表（增量）
 */
function updateStockList() {
    showConfirm('确定要更新股票列表吗？此操作将保留现有数据，只更新变化的部分。', function() {
        // 显示加载遮罩
        showLoading('正在更新股票列表，请稍候...');
        
        apiRequest('/stocks/update', 'POST', {},
            function(response) {
                hideLoading();
                if (response.success) {
                    const message = `股票列表更新成功！\n总数：${response.data.total}\n新增：${response.data.added}\n更新：${response.data.updated}`;
                    showMessage(message, 'success');
                    // 刷新数据统计
                    refreshDataStatus();
                } else {
                    showMessage('更新股票列表失败: ' + response.error, 'error');
                }
            },
            function(error) {
                hideLoading();
                showMessage('更新股票列表失败: ' + error, 'error');
            }
        );
    });
}

/**
 * 执行全量数据导入
 */
function importData() {
    showConfirm('确定要开始全量数据导入吗？任务将在后台执行，你可以关闭页面。', function() {
        // 不显示加载遮罩，让用户直接留在原页面
        apiRequest('/data/import', 'POST', {},
            function(response) {
                if (response.success && response.task_id) {
                    showMessage('导入任务已启动！任务ID: ' + response.task_id, 'success');
                    startProgressCheck(response.task_id);
                }
            },
            function(error) {
                showMessage('启动导入任务失败: ' + error, 'error');
            }
        );
    });
}

/**
 * 执行增量数据更新
 */
function updateData() {
    showConfirm('确定要开始增量数据更新吗？', function() {
        // 不显示加载遮罩，让用户直接留在原页面
        apiRequest('/data/update', 'POST', {},
            function(response) {
                if (response.success && response.task_id) {
                    showMessage('更新任务已启动！任务ID: ' + response.task_id, 'success');
                    startProgressCheck(response.task_id);
                }
            },
            function(error) {
                showMessage('启动更新任务失败: ' + error, 'error');
            }
        );
    });
}

/**
 * 开始进度检查
 */
function startProgressCheck(taskId) {
    currentTaskId = taskId;
    
    // 显示进度区域
    document.getElementById('task-progress-section').style.display = 'block';
    document.getElementById('task-id-display').textContent = taskId.substring(0, 8) + '...';
    
    // 立即检查一次
    checkTaskProgress(taskId);
    
    // 每3秒检查一次进度
    taskCheckInterval = setInterval(function() {
        checkTaskProgress(taskId);
    }, 3000);
}

/**
 * 检查任务进度
 */
function checkTaskProgress(taskId) {
    apiRequest('/data/tasks/' + taskId, 'GET', {},
        function(response) {
            if (response.success && response.data) {
                updateTaskProgressUI(response.data);
                
                // 如果任务完成或失败，停止检查
                if (response.data.status === 'completed' || response.data.status === 'failed') {
                    stopProgressCheck();
                    
                    // 刷新数据统计
                    setTimeout(refreshDataStatus, 2000);
                    
                    // 显示完成消息
                    if (response.data.status === 'completed') {
                        showMessage('任务已完成！', 'success');
                    } else {
                        showMessage('任务失败: ' + (response.data.error || '未知错误'), 'error');
                    }
                }
            }
        },
        function(error) {
            console.error('检查任务进度失败:', error);
        }
    );
}

/**
 * 更新任务进度UI
 */
function updateTaskProgressUI(taskData) {
    const progressBar = document.getElementById('task-progress-bar');
    const percentageEl = document.getElementById('task-percentage');
    const messageEl = document.getElementById('task-message');
    const statusBadge = document.getElementById('task-status-badge');
    const startTimeEl = document.getElementById('task-start-time');
    const cancelBtn = document.getElementById('btn-cancel-task');
    
    // 更新进度
    const progress = Math.round(taskData.progress || 0);
    progressBar.style.width = progress + '%';
    percentageEl.textContent = progress + '%';
    
    // 更新消息
    messageEl.textContent = taskData.message || '正在执行...';
    
    // 更新开始时间
    if (taskData.started_at) {
        startTimeEl.textContent = formatDateTime(taskData.started_at);
    }
    
    // 更新状态徽章和取消按钮
    statusBadge.className = 'badge';
    cancelBtn.style.display = 'none'; // 默认隐藏
    
    switch (taskData.status) {
        case 'pending':
            statusBadge.classList.add('bg-secondary');
            statusBadge.textContent = '等待中';
            cancelBtn.style.display = 'inline-block'; // 等待中可以取消
            break;
        case 'running':
            statusBadge.classList.add('bg-info');
            statusBadge.textContent = '运行中';
            cancelBtn.style.display = 'inline-block'; // 运行中可以取消
            break;
        case 'completed':
            statusBadge.classList.add('bg-success');
            statusBadge.textContent = '已完成';
            break;
        case 'failed':
            statusBadge.classList.add('bg-danger');
            statusBadge.textContent = '失败';
            break;
    }
}

/**
 * 停止进度检查
 */
function stopProgressCheck() {
    if (taskCheckInterval) {
        clearInterval(taskCheckInterval);
        taskCheckInterval = null;
    }
    currentTaskId = null;
}

/**
 * 取消任务
 */
function cancelTask() {
    if (!currentTaskId) {
        showMessage('没有正在运行的任务', 'warning');
        return;
    }
    
    showConfirm('确定要取消当前任务吗？取消后无法恢复。', function() {
        apiRequest('/data/tasks/' + currentTaskId + '/cancel', 'POST', {},
            function(response) {
                if (response.success) {
                    showMessage('任务已请求取消，请稍候...', 'success');
                    // 停止进度检查
                    stopProgressCheck();
                    // 5秒后刷新页面以查看最新状态
                    setTimeout(function() {
                        location.reload();
                    }, 5000);
                }
            },
            function(error) {
                showMessage('取消任务失败: ' + error, 'error');
            }
        );
    });
}

/**
 * 刷新数据状态
 */
function refreshDataStatus() {
    apiRequest('/data/status', 'GET', {},
        function(response) {
            if (response.success && response.data) {
                const data = response.data;
                
                // 更新统计信息
                document.getElementById('total-stocks').textContent = data.total_stocks || 0;
                document.getElementById('total-records').textContent = (data.record_count_millions || 0) + '万';
                
                // 更新日期范围
                const dateRangeEl = document.getElementById('date-range');
                if (data.earliest_date && data.latest_date) {
                    const start = data.earliest_date.substring(0, 10).replace(/-/g, '/');
                    const end = data.latest_date.substring(0, 10).replace(/-/g, '/');
                    dateRangeEl.innerHTML = start + '<br>至<br>' + end;
                }
            }
        },
        function(error) {
            console.error('刷新数据状态失败:', error);
        }
    );
}

/**
 * 页面加载时检查是否有正在运行的任务
 */
function checkRunningTasks() {
    apiRequest('/data/tasks?status=running&limit=1', 'GET', {},
        function(response) {
            if (response.success && response.data && response.data.length > 0) {
                const task = response.data[0];
                startProgressCheck(task.task_id);
            }
        },
        function(error) {
            console.error('检查运行中任务失败:', error);
        }
    );
}

// 页面加载完成后检查运行中的任务
document.addEventListener('DOMContentLoaded', function() {
    checkRunningTasks();
});

// 页面卸载时清除定时器
window.addEventListener('beforeunload', function() {
    stopProgressCheck();
});
</script>
{% endblock %}
